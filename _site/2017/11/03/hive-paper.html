<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.22.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hive 论文笔记 - Redmagic</title>
<meta name="description" content="Hive 论文笔记">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Redmagic">
<meta property="og:title" content="Hive 论文笔记">
<meta property="og:url" content="/2017/11/03/hive-paper.html">


  <meta property="og:description" content="Hive 论文笔记">







  <meta property="article:published_time" content="2017-11-03T00:00:00+08:00">






<link rel="canonical" href="/2017/11/03/hive-paper.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "/"
    
  }
</script>






<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Redmagic Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Redmagic
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hive 论文笔记">
    <meta itemprop="description" content="Hive 论文笔记">
    <meta itemprop="datePublished" content="2017-11-03T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Hive 论文笔记
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <h1 id="hive-论文笔记">Hive 论文笔记</h1>

<p>MapReduce 出现后，对数据的计算需求越来越多，而 MapReduce 提供的 API 太底层，学习成本和开发成本比较高，因此需要一个类 SQL 的工具，来代替大部分的 MapReduce 的使用场景。</p>

<h3 id="数据模型类型系统和查询语言">数据模型，类型系统和查询语言</h3>

<p>Hive 和传统的数据库一样有 Database 和 Table 的概念，数据存储在 Table 中。每个 Table 中会会很多行，每行有多列组成。</p>

<h5 id="类型">类型</h5>

<p>Hive 支持原生类型 (primitive types) 和复杂类型 (complex types)。</p>

<p>Primitive:</p>

<ul>
  <li>Integers: bigint, int, smallint, tinyint</li>
  <li>Float: float, double</li>
  <li>String</li>
</ul>

<p>Complex:</p>

<ul>
  <li>map&lt;key-type, value-type&gt;</li>
  <li>list<element-type></element-type></li>
  <li>struct&lt;field-name, field-type, …&gt;</li>
</ul>

<p>SerDe , Format 都是可插拔的，用户可以自定义 SerDe 或者 Format，在查询时可以通过 HiveQL 增加自己的 SerDe:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ADD JAR /jars/myformat.jar;
CREATE TABLE t2
ROW FORMAT SERDE 'com.myformat.MySerDe';
</code></pre></div></div>

<h5 id="hiveql">HiveQL</h5>

<p>HiveQL 和传统的 SQL 几乎没有差别，但是存在一些局限：</p>

<ul>
  <li>只能使用标准的 ANSI Join 语法</li>
  <li>JOIN 条件只能支持 <code class="language-plaintext highlighter-rouge">=</code> 运算符，不能使用 <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;</code></li>
  <li>Hive 不能支持正常的 <code class="language-plaintext highlighter-rouge">INSERT INTO</code>, 只能使用 <code class="language-plaintext highlighter-rouge">INSERT INTO OVERWRITE</code> 从已有的数据中生成</li>
</ul>

<p>Hive 中可以直接调用 MapReduce 程序：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM (
  MAP doctext USING 'python wc_mapper.py' AS (word, cnt)
  FROM docs
  CLUSTER BY word
) a
REDUCE word, cnt USING 'python wc_reduce.py';
</code></pre></div></div>

<p>Hive 提供了 <code class="language-plaintext highlighter-rouge">CLUSTER BY</code> 和 <code class="language-plaintext highlighter-rouge">DISTRIBUTE BY</code> 等语法改善 Reduce 的数据分布，解决数据倾斜问题</p>

<h3 id="data-storage-serde-and-file-formats">Data Storage, SerDe and File formats</h3>

<h5 id="data-storage">Data Storage</h5>

<p>Hive 的存储模型有 3 个层级</p>

<ul>
  <li>Tables 对应 HDFS 的一个目录</li>
  <li>Partitions 是 Table 的子目录</li>
  <li>Buckets 是目录下具体的文件</li>
</ul>

<blockquote>
  <p>Partition 的字段不是 Table 数据的一部分，而是保存在目录的名称中。比如 <code class="language-plaintext highlighter-rouge">/usr/hive/warehouse/t1/p_date=20170701</code></p>
</blockquote>

<p>Partition 可以优化查询性能，当用户指定 Partition 的情况下，Hive 只会扫描指定 Partition 下的文件。当 Hive 运行在 <code class="language-plaintext highlighter-rouge">strict</code> 模式时，用户需要指定只要一个 Partition 字段。</p>

<p>Bucket 相当于目录树的叶子节点，在创建表的时候用户可以指定需要多少个 Bucket，Bucket 可以用户数据的快速采样。</p>

<p>由于数据都保存在 HDFS 的表空间下，如果用户需要查询 HDFS 其他目录的文件，可以使用外部表：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE EXTERNAL TABLE test_extern(c1 string, c2 int)
LOCATION '/user/mytables/mydata';
</code></pre></div></div>

<p>外部表和普通表的唯一区别是当我们执行 <code class="language-plaintext highlighter-rouge">DROP TABLE</code> 时，外部表不会删除 HDFS 的文件。</p>

<h5 id="serde">SerDe</h5>

<p>SerDe 提供了几个 Java 接口，方便在文件格式和 Java Native 类型之间相互转化。默认的 SerDe 实现叫 <code class="language-plaintext highlighter-rouge">LazySerDe</code> ，是一种用文本表示数据的存储格式。这种格式用 <code class="language-plaintext highlighter-rouge">Ctrl-A</code> 来分割列，<code class="language-plaintext highlighter-rouge">\n</code> 来分割行。其他的 SerDe 实现包括 RegexSerDe, Thrift, Avro 等等。</p>

<h5 id="file-formats">File Formats</h5>

<p>Hadoop 上的文件可以以不同格式存储，Hive 默认的存储格式是一种叫 TextFormat 的格式，用类似 CSV 的纯文本表示数据。Format 可以在创建表的时候指定：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE TABLE dest1(key INT, value STRING)
  STORED AS
    INPUTFORMAT 'org.apache.hadoop.mapred.SequenceFileInputFormat'
    OUTPUTFORMAT 'org.apache.hadoop.mapred.SequenceFileOutputFormat';
</code></pre></div></div>

<p>存储格式可以根据自己的需求扩展，选择合适的存储格式有利于提高性能，比如面向列存储的 ParquetFile 和 ORCFile，可以减少读取的数据量，ORCFile 甚至可以做一些与计算，来满足 Push Down 的需求。</p>

<h5 id="系统架构和组件">系统架构和组件</h5>

<p>Hive 由下面的组件构成：</p>

<ul>
  <li>MetaStore - 存储系统目录看，还有数据库，表，列的各种原信息</li>
  <li>Driver - 管理 HiveQL 的生命周期</li>
  <li>Query Compiler - 将 Hive 的语句转换成一个 MapReduce 表达的 DAG</li>
  <li>Execution Engine - 将任务按照依赖顺序执行，早起版本只有 MapReduce，新版本应该有 Tez 和 Spark</li>
  <li>HiveServer - 提供 JDBC/ODBS 接口的服务，方便和其他系统集成</li>
  <li>Clients - Web UI 和命令行工具</li>
</ul>

<p>A. MetaStore</p>

<p>Hive 的 MetaStore 一般基于一个 RDBMS 来实现，提供了一个 ORM 层来作为数据库的抽象。MetaStore 本身不是为了高并发和高可用设计的，在架构中也是一个单点（新版本有主从了），所以 Hive 在设计的时候需要保证在任务执行期间没有任何对 MetaStore 的访问。</p>

<p>B. Query Compiler</p>

<p>Query Compiler 首先将 HQL 转换成一个 AST，然后进行类型检查和语法分析，将 AST 转换成一个 operator DAG （QB Tree），然后优化器对 QB Tree 进行优化。Hive 只支持基于规则的优化器，比如只读取指定列的数据减少 IO，或者用户指定分区字段时，只读取指定分区下的文件。
RBO 本质上是一个 Transformer，在 QB Tree 上做一系列的变换来减少查询的代价</p>

<blockquote>
  <p>Hive 0.1.4 开始引入了一些基于代价的优化器（CBO）。<a href="https://zh.hortonworks.com/blog/hive-0-14-cost-based-optimizer-cbo-technical-overview/">COST BASED OPTIMIZER</a></p>
</blockquote>

<p>之后就根据优化后的 QB Tree 生成物理执行计划，并且将 jar 包写入到 HDFS 的临时目录，开始运行。</p>

<p>C. Execution Engine</p>

<p>执行引擎会解析 plan.xml ，然后按照顺序将任务提交到 Hadoop，最终的数据库文件也会 move 到 HDFS 的指定目录。</p>


        
      </section>

      <footer class="page__meta">
        
        


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-11-03T00:00:00+08:00">November 3, 2017</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Hive+%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%20%2F2017%2F11%2F03%2Fhive-paper.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=%2F2017%2F11%2F03%2Fhive-paper.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2F2017%2F11%2F03%2Fhive-paper.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/2016/12/05/canary-deployment.html" class="pagination--pager" title="金丝雀发布
">Previous</a>
    
    
      <a href="/2018/02/25/bigtop-usage.html" class="pagination--pager" title="使用 BigTop 打包 Hadoop 全家桶
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2021/03/13/rocksdb-jni-api-notice.html" rel="permalink">RocksDB Java API Notice
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">RocksDB Java API Notice
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2020/06/07/ansible-quick-start.html" rel="permalink">Ansible 快速入门
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Ansible 快速入门
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2019/09/10/hive-locks.html" rel="permalink">Hive 锁机制
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Hive 锁机制
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2018/11/14/datasync-practice-in-zhihu.html" rel="permalink">大数据平台的数据同步服务实践
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">大数据平台的数据同步服务实践
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Redmagic. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
