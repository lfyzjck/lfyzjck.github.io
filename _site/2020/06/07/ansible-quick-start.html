<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.22.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Ansible 快速入门 - Redmagic</title>
<meta name="description" content="Ansible 快速入门">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Redmagic">
<meta property="og:title" content="Ansible 快速入门">
<meta property="og:url" content="/2020/06/07/ansible-quick-start.html">


  <meta property="og:description" content="Ansible 快速入门">







  <meta property="article:published_time" content="2020-06-07T00:00:00+08:00">






<link rel="canonical" href="/2020/06/07/ansible-quick-start.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "/"
    
  }
</script>






<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Redmagic Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Redmagic
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Ansible 快速入门">
    <meta itemprop="description" content="Ansible 快速入门">
    <meta itemprop="datePublished" content="2020-06-07T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Ansible 快速入门
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <h1 id="ansible-快速入门">Ansible 快速入门</h1>

<p>Ansible 是一个 IT 自动化软件，类似于 Puppet 和 Chef，是实现 Infra-as-a-code 的一种工具。</p>

<h2 id="quickstart">QuickStart</h2>

<h3 id="理解-ansible-如何控制远程服务器">理解 Ansible 如何控制远程服务器</h3>

<p>Ansible 的所有操作是基于 ssh 协议的，我们可以通过 ssh 命令在远程服务器上执行命令：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh root@ip <span class="s1">'ping baidu.com'</span>
PING baidu.com <span class="o">(</span>39.156.69.79<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 39.156.69.79 <span class="o">(</span>39.156.69.79<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>48 <span class="nb">time</span><span class="o">=</span>7.83 ms
64 bytes from 39.156.69.79 <span class="o">(</span>39.156.69.79<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>48 <span class="nb">time</span><span class="o">=</span>3.43 ms
64 bytes from 39.156.69.79 <span class="o">(</span>39.156.69.79<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span>3 <span class="nv">ttl</span><span class="o">=</span>48 <span class="nb">time</span><span class="o">=</span>3.45 ms
64 bytes from 39.156.69.79 <span class="o">(</span>39.156.69.79<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span>4 <span class="nv">ttl</span><span class="o">=</span>48 <span class="nb">time</span><span class="o">=</span>3.46 ms
</code></pre></div></div>

<p>在 Ansible 中编写的脚本最终也会被翻译成类似上面命令的方式被执行。</p>

<p>在 Ansible 执行的过程中，需要两种角色的节点，分别对应 ssh 的 client 和 server：</p>

<ul>
  <li>管理节点（执行 ansible 命令的机器）</li>
  <li>托管节点（被 ansible 的管理的机器）</li>
</ul>

<p>Ansible 的管理节点目前支持类 unix 系统，也就是 linux 和 macos。暂时不支持 windows 作为管理节点。管理节点可以是自己本地的电脑，但是由于私有化部署时我们面对的通常都是客户的内网环境，一般都无法在自己的开发机直接访问。为了简化使用方式，我们选择客户的一台服务器及作为管理节点也同时作为托管节点，所有 ansible 的操作总是从管理节点发起。</p>

<p>既然 Ansible 是基于 ssh 协议实现的，我们必须决定以哪个<strong>用户</strong>的身份登陆，以何种方式进行 <strong>ssh 认证</strong>，以及确保登陆用户有 <strong>sudo</strong> 的权限。ssh 常用的认证方式支持密码和证书两种，由于我们希望自动化部署，不想在部署过程中频繁的输入密码，因此配置证书认证是比较好的选择。另外很多客户环境下 sudo 也需要额外的密码，因此需要在初始化环境时配置 ssh 的登陆用户可以免密的进行 sudo 操作。</p>

<p>总结一下，我们需要：</p>

<ul>
  <li>选择一台客户内网的服务器作为管理节点，该节点通常也是我们的托管节点</li>
  <li>对托管节点配置基于证书的 ssh 免密登陆</li>
  <li>确保 ssh 登陆用户可以免密进行 sudo 操作</li>
</ul>

<h3 id="inventory-file">Inventory File</h3>

<p>Ansible 可同时操作属于一个组的多台主机,组和主机之间的关系通过 inventory 文件配置。默认的文件路径为 <code class="language-plaintext highlighter-rouge">/etc/ansible/hosts</code> 。不过我们通常不把  inventory file 放在系统目录下，而是放在单独的配置目录。</p>

<p>我们试着写一个 inventory file :</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">webserver</span><span class="pi">]</span>
<span class="s">host1</span>
<span class="s">host2</span>
</code></pre></div></div>

<p>保存为 <code class="language-plaintext highlighter-rouge">hosts</code> ，然后通过 ansible 的命令行执行 adhoc 命令</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ ansible all -i hosts -m ping</span>
<span class="s">host1 | UNREACHABLE! =&gt; {</span>
    <span class="s">"changed"</span><span class="pi">:</span> <span class="no">false</span><span class="s">,</span>
    <span class="s">"msg"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Failed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">connect</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">via</span><span class="nv"> </span><span class="s">ssh:</span><span class="nv"> </span><span class="s">ssh:</span><span class="nv"> </span><span class="s">Could</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">resolve</span><span class="nv"> </span><span class="s">hostname</span><span class="nv"> </span><span class="s">host1:</span><span class="nv"> </span><span class="s">nodename</span><span class="nv"> </span><span class="s">nor</span><span class="nv"> </span><span class="s">servname</span><span class="nv"> </span><span class="s">provided,</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">known"</span><span class="err">,</span>
    <span class="s2">"</span><span class="s">unreachable"</span><span class="pi">:</span> <span class="no">true</span>
<span class="err">}</span>
<span class="s">host2 | UNREACHABLE! =&gt; {</span>
    <span class="s">"changed"</span><span class="pi">:</span> <span class="no">false</span><span class="s">,</span>
    <span class="s">"msg"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Failed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">connect</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">via</span><span class="nv"> </span><span class="s">ssh:</span><span class="nv"> </span><span class="s">ssh:</span><span class="nv"> </span><span class="s">Could</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">resolve</span><span class="nv"> </span><span class="s">hostname</span><span class="nv"> </span><span class="s">host2:</span><span class="nv"> </span><span class="s">nodename</span><span class="nv"> </span><span class="s">nor</span><span class="nv"> </span><span class="s">servname</span><span class="nv"> </span><span class="s">provided,</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">known"</span><span class="err">,</span>
    <span class="s2">"</span><span class="s">unreachable"</span><span class="pi">:</span> <span class="no">true</span>
<span class="err">}</span>
</code></pre></div></div>

<p>其中 <code class="language-plaintext highlighter-rouge">all</code> 是 <code class="language-plaintext highlighter-rouge">&lt;host-pattern&gt;</code> ,  <code class="language-plaintext highlighter-rouge">all</code> 是一个特殊的 pattern，匹配所有 hosts。提示报错是预期的结果，因为 host1, host2 并不存在。</p>

<h3 id="playbookroletask">Playbook，Role，Task</h3>

<p>上一节展示了如何通过 ansible 执行 adhoc 命令，但是大部分时候我们用的更多的是 <code class="language-plaintext highlighter-rouge">ansible-playbook</code> 命令。Playbook 是 ansible 的任务编排语言，通过 YAML 来描述。关于 Playbook 和 role， task 的关系，一句话就可以说清楚：剧本 (playbook) 开始，角色们（role) 依次登上舞台，完成自己的任务 (task)。</p>

<p>playbook 一般是 ansible 执行的入口；role 更像是模块，是我们复用代码的基本单位；task 是一个个具体的实现。</p>

<p>先从一个不考虑复用的 playbook 开始：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">install vim</span>
      <span class="na">yum</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">vim</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">present</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">install jdk</span>
      <span class="na">yum</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">openjdk</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">present</span>
</code></pre></div></div>

<p>这个 playbook 会在所有机器上安装 vim 和 openjdk。yum 是 ansible 提供的一个模块，ansible 拥有非常强大的生态，我们需要几乎所有操作都被 ansible 很好的封装了。所有模块的文档可以参考：<a href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html">https://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a></p>

<p>随着 task 越来越多，playbook 会变得非常长而且不容易维护，中间如果有重复部分也难以实现代码复用。这个时候就轮到角色（role） 登场了。</p>

<h3 id="编写可复用的脚本">编写可复用的脚本</h3>

<p>role 从代码上看就是一个特定结构的目录，典型的 role 目录结构如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">site.yml</span>
<span class="s">webservers.yml</span>
<span class="s">fooservers.yml</span>
<span class="s">roles/</span>
   <span class="s">common/</span>
     <span class="s">files/</span>
     <span class="s">templates/</span>
     <span class="s">tasks/</span>
     <span class="s">handlers/</span>
     <span class="s">vars/</span>
     <span class="s">defaults/</span>
     <span class="s">meta/</span>
   <span class="s">webservers/</span>
     <span class="s">files/</span>
     <span class="s">templates/</span>
     <span class="s">tasks/</span>
     <span class="s">handlers/</span>
     <span class="s">vars/</span>
     <span class="s">defaults/</span>
     <span class="s">meta/</span>
</code></pre></div></div>

<p>每个目录下默认的入口都是 <code class="language-plaintext highlighter-rouge">main.yml</code> 这个文件。然后我们可以在 playbook 中引入这个 role：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">webservers</span>
  <span class="na">roles</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">common</span>
     <span class="pi">-</span> <span class="s">webservers</span>
</code></pre></div></div>

<p>role 和 role 之间可以设置依赖关系，通过依赖我们可以隐式的执行某些 role。角色依赖需要定义在 <code class="language-plaintext highlighter-rouge">meta/main.yml</code> 文件中：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">dependencies</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">role</span><span class="pi">:</span> <span class="nv">common</span><span class="pi">,</span> <span class="nv">some_parameter</span><span class="pi">:</span> <span class="nv">3</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">role</span><span class="pi">:</span> <span class="nv">apache</span><span class="pi">,</span> <span class="nv">port</span><span class="pi">:</span> <span class="nv">80</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">role</span><span class="pi">:</span> <span class="nv">postgres</span><span class="pi">,</span> <span class="nv">dbname</span><span class="pi">:</span> <span class="nv">blarg</span><span class="pi">,</span> <span class="nv">other_parameter</span><span class="pi">:</span> <span class="nv">12</span> <span class="pi">}</span>
</code></pre></div></div>

<blockquote>
  <p>当一个 playbook 包含多个 role，并且 role 依赖了共同的 role 时，可能会有重复执行的情况。ansible 有一些机制避免重复无意义的执行，但是该规则不是很容易直观理解。</p>
</blockquote>

<h2 id="变量">变量</h2>

<h3 id="变量的定义"><strong>变量的定义</strong></h3>

<p><strong>Inventory File</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[all:vars]
foo1=bar
foo2=bar2

[group1]
host1
host2

[group1:vars]
foo3=bar3
</code></pre></div></div>

<p><strong>PlayBook</strong></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">http_port</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">vars_prompt</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">service_name</span>
      <span class="na">prompt</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Which</span><span class="nv"> </span><span class="s">service</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">you</span><span class="nv"> </span><span class="s">want</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">remove?"</span>
      <span class="na">private</span><span class="pi">:</span> <span class="s">no</span>
  <span class="na">vars_files</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/vars/external_vars.yml</span>
</code></pre></div></div>

<p><strong>Role</strong></p>

<p>有些变量只用于当前 role，可能会定义在 role 当中。一般位于 <code class="language-plaintext highlighter-rouge">defaults/mian.yml</code> 或者 <code class="language-plaintext highlighter-rouge">vars/</code> 目录下。</p>

<p>具体的使用参见：<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html</a></p>

<p><strong>Ansible 预定义</strong></p>

<p>部分变量是 Ansible 自己定义的变量，比如我们要获取机器的 hostname：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{{</span> ansible_facts[<span class="s1">'nodename'</span><span class="o">]</span> <span class="o">}}</span>
</code></pre></div></div>

<p>这部分预定义变量非常多，可以通过下面命令查看：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible <span class="nb">hostname</span> <span class="nt">-m</span> setup
<span class="o">{</span>
    <span class="s2">"ansible_all_ipv4_addresses"</span>: <span class="o">[</span>
        <span class="s2">"REDACTED IP ADDRESS"</span>
    <span class="o">]</span>,
    <span class="s2">"ansible_all_ipv6_addresses"</span>: <span class="o">[</span>
        <span class="s2">"REDACTED IPV6 ADDRESS"</span>
    <span class="o">]</span>,
    <span class="s2">"ansible_apparmor"</span>: <span class="o">{</span>
        <span class="s2">"status"</span>: <span class="s2">"disabled"</span>
    <span class="o">}</span>,
    <span class="s2">"ansible_architecture"</span>: <span class="s2">"x86_64"</span>,
    <span class="s2">"ansible_bios_date"</span>: <span class="s2">"11/28/2013"</span>
		......
<span class="o">}</span>
</code></pre></div></div>

<p><strong>Command Line</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook site.yml <span class="nt">--extra-vars</span><span class="o">=</span><span class="s1">'{"foo": "bar"}'</span>
</code></pre></div></div>

<p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html</a></p>

<h3 id="变量的作用域">变量的作用域</h3>

<p>ansible 的变量作用域主要有 3 种：</p>

<ul>
  <li>Global：ansible 配置文件，环境变量，命令行</li>
  <li>Play：playbook vars, vars_prompt, vars_files; role defaults, vars</li>
  <li>Host: Inventory 中定义的的 host vars; facts</li>
</ul>

<h3 id="变量使用">变量使用</h3>

<p>ansible 允许你在各处通过 jinja2 的语法使用变量。jinja2 是一个用 Python 开发的模版引擎，本身并不复杂，核心东西就 3 个：变量的输出，控制流，filter</p>

<p>两个大括号包起来表示输出变量：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>I'm {{ name }}
</code></pre></div></div>

<p>变量输出时可以用过 filter 控制格式，类似 bash 里的 pipeline。filter 本质上是一个 Python 的函数，有一个入参和一个返回结果：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>I'm {{ name | trim | title }}
</code></pre></div></div>

<p>控制流需要区别于输出，用 <code class="language-plaintext highlighter-rouge">{% %}</code> 表示。比如一个 for 循环</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{% for name in names %}
I'm {{ name | title }}
{% endfor %}
</code></pre></div></div>

<p>条件判断</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{% for name in names %}
{% if ignore_case %}
I'm {{ name | lower }}
{% else %}
I'm {{ name }}
{% endif %}
{% endif %}
</code></pre></div></div>

<p>上面就是 jinja2 的介绍，更多细节需要去看文档。</p>

<p>需要注意的是，在 Ansible 中如果你要使用 jinja2 的语法去引用一个变量，必须用双引号内使用。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">deploy_path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">home_dir</span><span class="nv"> </span><span class="s">}}/apps"</span>
</code></pre></div></div>

<p>比如我们想根据各种上下文生成 nginx 的配置文件，可以通过 template 命令来渲染。首先定一个模版文件 <code class="language-plaintext highlighter-rouge">nginx.conf.j2</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
  server_name {{ server_name }};
  listen 80;
  
  location / {
    try_files $uri $uri/ /index.html;
  }
}
</code></pre></div></div>

<p>我们希望这个配置文件可以覆盖默认的 nginx 配置：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">server_name</span><span class="pi">:</span> <span class="s">gio.com</span>
    <span class="na">nginx_user</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">nginx_group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">nginx_user</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">tasks</span><span class="pi">:</span>
<span class="err">	</span><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">generate nginx config file</span>
<span class="err">	</span>  <span class="na">template</span><span class="pi">:</span>
<span class="err">	</span>    <span class="na">src</span><span class="pi">:</span> <span class="s">nginx.conf.j2</span>
<span class="err">	</span>    <span class="na">dest</span><span class="pi">:</span> <span class="s">/etc/nginx/nginx.conf</span>
<span class="err">	</span>    <span class="na">owner</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">nginx_user</span><span class="nv"> </span><span class="s">}}"</span>
<span class="err">	</span>    <span class="na">group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">nginx_group</span><span class="nv"> </span><span class="s">}}"</span>
<span class="err">	  </span><span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
</code></pre></div></div>

<h2 id="最佳实践">最佳实践</h2>

<h3 id="保持操作的幂等">保持操作的幂等</h3>

<p>shell 脚本在执行时，很多命令的执行结果不是确定的。很多时候我们无法避免的需要反复重试某些脚本：</p>

<ul>
  <li>脚本自身有 bug，修完以后需要重试</li>
  <li>机器状态不确定。比如脚本执行过程中机器重启了；免密 sudo 忘记配置结果执行到某个需要 sudo 的 task 时跪了。</li>
  <li>命令本身执行结果就是不确定的，比如通过 systemd 启动一个进程，systemctl start 命令返回成功并不代表真的启动成功了。</li>
</ul>

<p>ansible 的写法都是声明式而不是命令式。命令描述过程，声明式描述意图。明确的意图可以让 ansible 可以更好的帮你决定是否要重试某个任务，安全的隐藏细节。比如我们删除某个文件，命令式描述这样的：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">delete file</span>
  <span class="na">command</span><span class="pi">:</span> <span class="s">rm /tmp/xxx</span>
</code></pre></div></div>

<p>但是当我们重复跑这个 task 时，已经被删除文件无法再次被删除，需要在每次删除前检查目标文件是否已经被删除。但是用声明式的写法就很容易实现：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">delete file</span>
  <span class="na">file</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">/tmp/xxx</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">absent</span>
</code></pre></div></div>

<p>编写 ansible 脚本时，要始终记得一件事：不要想着你要做什么操作，而是描述你期望某个对象的状态是怎么样的。</p>

<h3 id="谨慎处理非-root-用户运行时的逻辑">谨慎处理非 root 用户运行时的逻辑</h3>

<p>ansible 的 task 有两个属性 <code class="language-plaintext highlighter-rouge">become</code> 和 <code class="language-plaintext highlighter-rouge">become_user</code> ，分别代表是否要使用 sudo 以及 sudo 的用户。比如创建一个目录并指定目录的 owner 和 group</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">create dir</span>
  <span class="na">file</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/etc/foo</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">directory</span>
    <span class="na">owner</span><span class="pi">:</span> <span class="s">foo</span>
    <span class="na">group</span><span class="pi">:</span> <span class="s">foo</span>
</code></pre></div></div>

<p>如果我们以 root 用户的身份执行 ansible 脚本，上面的脚本没有任何问题。但是如果是一个有 sudo 权限的普通用户，如果没有显式使用 sudo 的话，没有权限在 <code class="language-plaintext highlighter-rouge">/etc</code> 目录下创建任何东西。这是时候就需要使用 <code class="language-plaintext highlighter-rouge">become</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">create dir</span>
  <span class="na">file</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/etc/foo</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">directory</span>
    <span class="na">owner</span><span class="pi">:</span> <span class="s">foo</span>
    <span class="na">group</span><span class="pi">:</span> <span class="s">foo</span>
  <span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
</code></pre></div></div>

<h3 id="测试脚本">测试脚本</h3>

<p>检查语法：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">ansible-playbook --syntax-check &lt;playbook&gt;</span>
</code></pre></div></div>

<p>Dry-run:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">ansible-playbook --check &lt;playbook&gt;</span>
</code></pre></div></div>

<p>真实执行脚本：</p>

<p>由于测试可能需要反复执行，每次都申请服务器显然不现实，推荐本地用 VirtualBox + Vagrant 来进行测试。</p>

<p>首先定义 Vargrantfile，来创建 3 个虚拟机，hostname 是 hadoop[1-3]</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ cat Vagrantfile</span>                                                                                                                                                    
<span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

<span class="c1"># All Vagrant configuration is done below. The "2" in Vagrant.configure</span>
<span class="c1"># configures the configuration version (we support older styles for</span>
<span class="c1"># backwards compatibility). Please don't change it unless you know what</span>
<span class="c1"># you're doing.</span>
<span class="s">Vagrant.configure("2") do |config|</span>
  <span class="s">config.vm.define 'hadoop01' do |hadoop01|</span>
    <span class="s">hadoop01.vm.box = 'centos/7'</span>
    <span class="s">hadoop01.vm.hostname = 'hadoop01'</span>
    <span class="s">hadoop01.vm.network "forwarded_port", guest</span><span class="pi">:</span> <span class="s">80, host</span><span class="pi">:</span> <span class="m">8000</span>
    <span class="s">hadoop01.vm.network :private_network, :ip =&gt; '192.168.10.192'</span>
    <span class="s">hadoop01.vm.provision :hosts, :sync_hosts =&gt; </span><span class="no">true</span>
    <span class="s">hadoop01.vm.provision :hosts, :add_localhost_hostnames =&gt; </span><span class="no">false</span>
    <span class="s">hadoop01.vm.provider :virtualbox do |v|</span>
      <span class="s">v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]</span>
      <span class="s">v.customize ["modifyvm", :id, "--memory", 2048]</span>
      <span class="s">v.customize ["modifyvm", :id, "--name", "hadoop01"]</span>
    <span class="s">end</span>
  <span class="s">end</span>

  <span class="s">config.vm.define 'hadoop02' do |hadoop02|</span>
    <span class="s">hadoop02.vm.box = 'centos/7'</span>
    <span class="s">hadoop02.vm.hostname = 'hadoop02'</span>
    <span class="s">hadoop02.vm.network "forwarded_port", guest</span><span class="pi">:</span> <span class="s">80, host</span><span class="pi">:</span> <span class="m">8001</span>
    <span class="s">hadoop02.vm.network :private_network, :ip =&gt; '192.168.10.193'</span>
    <span class="s">hadoop02.vm.provision :hosts, :sync_hosts =&gt; </span><span class="no">true</span>
    <span class="s">hadoop02.vm.provision :hosts, :add_localhost_hostnames =&gt; </span><span class="no">false</span>
    <span class="s">hadoop02.vm.provider :virtualbox do |v|</span>
      <span class="s">v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]</span>
      <span class="s">v.customize ["modifyvm", :id, "--memory", 2048]</span>
      <span class="s">v.customize ["modifyvm", :id, "--name", "hadoop02"]</span>
    <span class="s">end</span>
  <span class="s">end</span>

  <span class="s">config.vm.define 'hadoop03' do |hadoop03|</span>
    <span class="s">hadoop03.vm.box = 'centos/7'</span>
    <span class="s">hadoop03.vm.hostname = 'hadoop03'</span>
    <span class="s">hadoop03.vm.network "forwarded_port", guest</span><span class="pi">:</span> <span class="s">80, host</span><span class="pi">:</span> <span class="m">8002</span>
    <span class="s">hadoop03.vm.network :private_network, :ip =&gt; '192.168.10.194'</span>
    <span class="s">hadoop03.vm.provision :hosts, :sync_hosts =&gt; </span><span class="no">true</span>
    <span class="s">hadoop03.vm.provision :hosts, :add_localhost_hostnames =&gt; </span><span class="no">false</span>
    <span class="s">hadoop03.vm.provider :virtualbox do |v|</span>
      <span class="s">v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]</span>
      <span class="s">v.customize ["modifyvm", :id, "--memory", 2048]</span>
      <span class="s">v.customize ["modifyvm", :id, "--name", "hadoop03"]</span>
    <span class="s">end</span>
  <span class="s">end</span>
<span class="s">end</span>
</code></pre></div></div>

<p>启动服务器并配置 ssh</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ vagrant up</span>

<span class="s">$ vagrat ssh-config</span>
</code></pre></div></div>

<p>创建一个用于测试的 inventory file，然后执行 playbook：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">ansible-playbook &lt;playbook&gt; -i &lt;inventory_file&gt;</span>
</code></pre></div></div>

<p>单元测试：</p>

<p>ansible 的单元测试比较接近集成测试。有第一个第三方的框架可以支持：</p>

<p><a href="https://molecule.readthedocs.io/en/latest/">https://molecule.readthedocs.io/en/latest/</a></p>

<p>细节比较多这里不单独介绍，执行也需要依赖 docker 或者 vagrant</p>

<h2 id="reference">Reference</h2>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Infrastructure_as_code">https://en.wikipedia.org/wiki/Infrastructure_as_code</a></li>
  <li><a href="https://ansible-tran.readthedocs.io/en/latest/docs/intro.html">https://ansible-tran.readthedocs.io/en/latest/docs/intro.html</a></li>
</ul>


        
      </section>

      <footer class="page__meta">
        
        


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-06-07T00:00:00+08:00">June 7, 2020</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Ansible+%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%20%2F2020%2F06%2F07%2Fansible-quick-start.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=%2F2020%2F06%2F07%2Fansible-quick-start.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2F2020%2F06%2F07%2Fansible-quick-start.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/2019/09/10/hive-locks.html" class="pagination--pager" title="Hive 锁机制
">Previous</a>
    
    
      <a href="/2021/03/13/rocksdb-jni-api-notice.html" class="pagination--pager" title="RocksDB Java API Notice
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2021/03/13/rocksdb-jni-api-notice.html" rel="permalink">RocksDB Java API Notice
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">RocksDB Java API Notice
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2019/09/10/hive-locks.html" rel="permalink">Hive 锁机制
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Hive 锁机制
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2018/11/14/datasync-practice-in-zhihu.html" rel="permalink">大数据平台的数据同步服务实践
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">大数据平台的数据同步服务实践
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2018/07/05/sqoop-cheatsheet.html" rel="permalink">Sqoop 使用指南
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Sqoop 使用指南
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Redmagic. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
